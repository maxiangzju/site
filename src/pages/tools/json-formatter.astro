---
import BaseLayout from '../../components/layout/BaseLayout.astro';
---

<BaseLayout title="JSON Formatter | Xiang's Island">
  <div class="max-w-5xl mx-auto px-4 py-16">
    <div class="mb-8">
      <a href="/tools" class="text-[var(--color-primary)] hover:underline mb-2 inline-block">← Back to Tools</a>
      <h1 class="text-3xl font-bold mb-2">JSON Formatter / Validator</h1>
      <p class="text-[var(--color-text-muted)]">
        Format, validate, and minify JSON data with syntax highlighting.
      </p>
    </div>

    <div class="grid lg:grid-cols-2 gap-6">
      <div>
        <div class="flex items-center justify-between mb-3">
          <label for="input" class="text-lg font-semibold">Input</label>
          <button
            id="clearBtn"
            class="px-3 py-1 text-sm bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded hover:border-[var(--color-primary)] transition-colors"
          >
            Clear
          </button>
        </div>
        <textarea
          id="input"
          placeholder='{"example": "paste your JSON here"}'
          class="w-full h-[400px] p-4 bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded-lg text-[var(--color-text)] font-mono text-sm resize-none focus:outline-none focus:border-[var(--color-primary)] transition-colors"
        ></textarea>
      </div>

      <div>
        <div class="flex items-center justify-between mb-3">
          <label for="output" class="text-lg font-semibold">Output</label>
          <button
            id="copyBtn"
            class="px-3 py-1 text-sm bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded hover:border-[var(--color-primary)] transition-colors"
          >
            Copy
          </button>
        </div>
        <div
          id="output"
          class="w-full h-[400px] p-4 bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded-lg text-[var(--color-text)] font-mono text-sm overflow-auto"
        >
          <span class="text-[var(--color-text-muted)]">Formatted JSON will appear here...</span>
        </div>
      </div>
    </div>

    <div class="mt-6 flex flex-wrap gap-3">
      <button
        id="formatBtn"
        class="px-6 py-2 bg-[var(--color-primary)] text-white rounded-lg hover:bg-[var(--color-primary-dark)] transition-colors font-medium"
      >
        Format
      </button>
      <button
        id="minifyBtn"
        class="px-6 py-2 bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded-lg hover:border-[var(--color-primary)] transition-colors"
      >
        Minify
      </button>
      <button
        id="validateBtn"
        class="px-6 py-2 bg-[var(--color-bg-secondary)] border border-[var(--color-border)] rounded-lg hover:border-[var(--color-primary)] transition-colors"
      >
        Validate
      </button>
    </div>

    <div id="statusMessage" class="mt-4 p-3 rounded-lg hidden"></div>
  </div>
</BaseLayout>

<script>
  const input = document.getElementById('input') as HTMLTextAreaElement;
  const output = document.getElementById('output') as HTMLDivElement;
  const formatBtn = document.getElementById('formatBtn') as HTMLButtonElement;
  const minifyBtn = document.getElementById('minifyBtn') as HTMLButtonElement;
  const validateBtn = document.getElementById('validateBtn') as HTMLButtonElement;
  const clearBtn = document.getElementById('clearBtn') as HTMLButtonElement;
  const copyBtn = document.getElementById('copyBtn') as HTMLButtonElement;
  const statusMessage = document.getElementById('statusMessage') as HTMLDivElement;

  let currentOutput = '';

  function showStatus(message: string, isError = false) {
    statusMessage.textContent = message;
    statusMessage.className = `mt-4 p-3 rounded-lg ${
      isError
        ? 'bg-red-900/30 border border-red-500/50 text-red-300'
        : 'bg-green-900/30 border border-green-500/50 text-green-300'
    }`;
    statusMessage.classList.remove('hidden');
    setTimeout(() => statusMessage.classList.add('hidden'), 3000);
  }

  function syntaxHighlight(json: string): string {
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(
      /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
      (match) => {
        let cls = 'text-orange-400';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'text-cyan-400';
          } else {
            cls = 'text-green-400';
          }
        } else if (/true|false/.test(match)) {
          cls = 'text-purple-400';
        } else if (/null/.test(match)) {
          cls = 'text-red-400';
        }
        return `<span class="${cls}">${match}</span>`;
      }
    );
  }

  formatBtn.addEventListener('click', () => {
    try {
      const parsed = JSON.parse(input.value);
      const formatted = JSON.stringify(parsed, null, 2);
      currentOutput = formatted;
      output.innerHTML = `<pre>${syntaxHighlight(formatted)}</pre>`;
      showStatus('✓ JSON formatted successfully');
    } catch (e) {
      showStatus(`✗ Invalid JSON: ${(e as Error).message}`, true);
    }
  });

  minifyBtn.addEventListener('click', () => {
    try {
      const parsed = JSON.parse(input.value);
      const minified = JSON.stringify(parsed);
      currentOutput = minified;
      output.innerHTML = `<pre>${syntaxHighlight(minified)}</pre>`;
      showStatus('✓ JSON minified successfully');
    } catch (e) {
      showStatus(`✗ Invalid JSON: ${(e as Error).message}`, true);
    }
  });

  validateBtn.addEventListener('click', () => {
    try {
      JSON.parse(input.value);
      showStatus('✓ Valid JSON!');
    } catch (e) {
      showStatus(`✗ Invalid JSON: ${(e as Error).message}`, true);
    }
  });

  clearBtn.addEventListener('click', () => {
    input.value = '';
    output.innerHTML = '<span class="text-[var(--color-text-muted)]">Formatted JSON will appear here...</span>';
    currentOutput = '';
  });

  copyBtn.addEventListener('click', async () => {
    if (currentOutput) {
      await navigator.clipboard.writeText(currentOutput);
      showStatus('✓ Copied to clipboard!');
    }
  });
</script>
