---
interface Props {
  width?: number;
  height?: number;
}

const { width = 1000, height = 700 } = Astro.props;
---

<div class="tank-game-container" id="tank-game-wrapper">
  <canvas
    id="tank-game-canvas"
    width={width}
    height={height}
    class="rounded-lg shadow-lg cursor-crosshair"
  ></canvas>

  <!-- Mobile touch hints overlay -->
  <div id="mobile-hints" class="mobile-hints hidden">
    <div class="hint-left">
      <div class="hint-circle"></div>
      <span>MOVE</span>
    </div>
    <div class="hint-right">
      <div class="hint-circle"></div>
      <span>AIM & FIRE</span>
    </div>
  </div>

  <div class="controls mt-4 flex gap-2 sm:gap-4 items-center flex-wrap justify-center">
    <button id="tank-start-btn" class="btn-control bg-[var(--color-primary)] hover:bg-[var(--color-primary-dark)]">
      Start
    </button>
    <button id="tank-pause-btn" class="btn-control bg-yellow-600 hover:bg-yellow-700">
      Pause
    </button>
    <button id="tank-restart-btn" class="btn-control bg-gray-600 hover:bg-gray-700">
      Restart
    </button>
    <button id="tank-fullscreen-btn" class="btn-control bg-purple-600 hover:bg-purple-700">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
      </svg>
      <span>Fullscreen</span>
    </button>
    <button id="tank-autofire-btn" class="btn-control bg-green-600 hover:bg-green-700">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="22" y1="12" x2="18" y2="12"></line>
        <line x1="6" y1="12" x2="2" y2="12"></line>
        <line x1="12" y1="6" x2="12" y2="2"></line>
        <line x1="12" y1="22" x2="12" y2="18"></line>
      </svg>
      <span class="btn-text">Auto: ON</span>
    </button>
  </div>
</div>

<script>
  import { TankGameEngine } from './engines/tank/TankGameEngine';

  let engine: TankGameEngine | null = null;
  let isFullscreen = false;
  let autoFireEnabled = true; // Auto-fire on by default

  function isMobile(): boolean {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
      || window.innerWidth < 768;
  }

  function initTankGame() {
    // Clean up previous instance if it exists
    if (engine) {
      engine.dispose();
    }

    const canvas = document.getElementById('tank-game-canvas') as HTMLCanvasElement;
    const wrapper = document.getElementById('tank-game-wrapper');
    const startBtn = document.getElementById('tank-start-btn');
    const pauseBtn = document.getElementById('tank-pause-btn');
    const restartBtn = document.getElementById('tank-restart-btn');
    const fullscreenBtn = document.getElementById('tank-fullscreen-btn');
    const autofireBtn = document.getElementById('tank-autofire-btn');
    const mobileHints = document.getElementById('mobile-hints');

    if (!canvas || !startBtn || !pauseBtn || !restartBtn || !fullscreenBtn || !wrapper || !autofireBtn) return;

    // Define updateAutoFireButton early so it can be used below
    function updateAutoFireButton() {
      const btnText = autofireBtn.querySelector('.btn-text');
      if (btnText) {
        btnText.textContent = autoFireEnabled ? 'Auto: ON' : 'Auto: OFF';
      }
      autofireBtn.classList.toggle('bg-green-600', autoFireEnabled);
      autofireBtn.classList.toggle('hover:bg-green-700', autoFireEnabled);
      autofireBtn.classList.toggle('bg-orange-600', !autoFireEnabled);
      autofireBtn.classList.toggle('hover:bg-orange-700', !autoFireEnabled);
    }

    // Create and initialize engine
    engine = new TankGameEngine();
    engine.init(canvas);

    // Detect mobile and show hints
    const mobile = isMobile();

    // Enable auto-fire by default (already true, just sync with engine)
    engine.setAutoFire(autoFireEnabled);
    updateAutoFireButton();

    // Show mobile hints briefly on touch devices
    if (mobile && mobileHints) {
      mobileHints.classList.remove('hidden');
      setTimeout(() => {
        mobileHints.classList.add('fade-out');
        setTimeout(() => {
          mobileHints.classList.add('hidden');
          mobileHints.classList.remove('fade-out');
        }, 1000);
      }, 3000);
    }

    // Handle resize
    function handleResize() {
      if (!engine) return;

      if (isFullscreen) {
        // In fullscreen, use full window size
        const width = window.innerWidth;
        const height = window.innerHeight - 60; // Leave space for controls
        canvas.width = width;
        canvas.height = height;
        engine.resize(width, height);
      } else {
        // Responsive sizing
        const container = canvas.parentElement;
        if (container) {
          const rect = container.getBoundingClientRect();
          const maxWidth = Math.min(rect.width - 16, 1000);
          const aspectRatio = 0.7;

          // On mobile, use more of the screen height
          let width = maxWidth;
          let height = Math.round(width * aspectRatio);

          // Constrain height on small screens
          const maxHeight = window.innerHeight - 200; // Leave room for controls
          if (height > maxHeight) {
            height = maxHeight;
            width = Math.round(height / aspectRatio);
          }

          canvas.width = width;
          canvas.height = height;
          engine.resize(width, height);
        }
      }
    }

    window.addEventListener('resize', handleResize);
    handleResize();

    // Control buttons
    startBtn.addEventListener('click', () => {
      if (engine) {
        engine.start();
      }
    });

    pauseBtn.addEventListener('click', () => {
      if (engine) {
        const state = engine.getState();
        engine.setPaused(!state.isPaused);
        pauseBtn.textContent = state.isPaused ? 'Pause' : 'Resume';
      }
    });

    restartBtn.addEventListener('click', () => {
      if (engine) {
        engine.dispose();
        engine = new TankGameEngine();
        engine.init(canvas);
        if (autoFireEnabled) {
          engine.setAutoFire(true);
        }
        engine.start();
        pauseBtn.textContent = 'Pause';
      }
    });

    // Fullscreen toggle
    function updateFullscreenButton() {
      const btnText = fullscreenBtn.querySelector('span');
      if (btnText) {
        btnText.textContent = isFullscreen ? 'Exit' : 'Fullscreen';
      }
    }

    // Enter/exit mobile fullscreen mode (CSS-based)
    function toggleMobileFullscreen() {
      isFullscreen = !isFullscreen;
      document.body.classList.toggle('game-fullscreen', isFullscreen);
      wrapper.classList.toggle('mobile-fullscreen', isFullscreen);
      updateFullscreenButton();

      // Resize after a short delay to let CSS take effect
      setTimeout(() => {
        handleResize();
      }, 50);
    }

    fullscreenBtn.addEventListener('click', async () => {
      // Always use CSS-based fullscreen (more reliable across devices)
      toggleMobileFullscreen();
    });

    // Handle escape key to exit fullscreen
    function handleKeyDown(e: KeyboardEvent) {
      if (isFullscreen && (e.key === 'Escape')) {
        e.preventDefault();
        toggleMobileFullscreen();
      }
    }
    window.addEventListener('keydown', handleKeyDown);

    autofireBtn.addEventListener('click', () => {
      autoFireEnabled = !autoFireEnabled;
      if (engine) {
        engine.setAutoFire(autoFireEnabled);
      }
      updateAutoFireButton();
    });

    // Auto-start
    engine.start();

    // Cleanup on navigation
    document.addEventListener('astro:before-swap', () => {
      if (engine) {
        engine.dispose();
        engine = null;
      }
      window.removeEventListener('resize', handleResize);
      window.removeEventListener('keydown', handleKeyDown);
      // Clean up mobile fullscreen state
      document.body.classList.remove('game-fullscreen');
    }, { once: true });
  }

  // Initialize on page load
  initTankGame();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:after-swap', initTankGame);
</script>

<style>
  .tank-game-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    touch-action: none; /* Prevent browser gestures on touch */
  }

  .tank-game-container:fullscreen {
    background: #0a0a1e;
    padding: 0;
    justify-content: flex-start;
  }

  .tank-game-container:fullscreen .controls {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.8);
    padding: 10px;
    margin: 0;
    z-index: 100;
    justify-content: center;
  }

  .tank-game-container:fullscreen #tank-game-canvas {
    border-radius: 0;
  }

  #tank-game-canvas {
    max-width: 100%;
    height: auto;
    background: #1a1a2e;
    touch-action: none;
  }

  .btn-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    color: white;
    border-radius: 0.375rem;
    transition: background-color 0.2s;
    font-size: 0.875rem;
    white-space: nowrap;
  }

  @media (min-width: 640px) {
    .btn-control {
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
  }

  /* Mobile touch hints */
  .mobile-hints {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem;
    background: rgba(0, 0, 0, 0.5);
    z-index: 50;
  }

  .mobile-hints.hidden {
    display: none;
  }

  .mobile-hints.fade-out {
    animation: fadeOut 1s ease-out forwards;
  }

  @keyframes fadeOut {
    to {
      opacity: 0;
    }
  }

  .hint-left, .hint-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: white;
    font-size: 0.875rem;
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  .hint-circle {
    width: 60px;
    height: 60px;
    border: 3px solid rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      opacity: 0.8;
    }
    50% {
      transform: scale(1.1);
      opacity: 1;
    }
  }

  /* Hide some text on very small screens */
  @media (max-width: 400px) {
    .btn-text {
      display: none;
    }
  }

  /* Mobile fullscreen mode (CSS-based) */
  .mobile-fullscreen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    z-index: 99999 !important;
    background: #0a0a1e !important;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden !important;
    /* Ensure flex display is preserved */
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: flex-start !important;
  }

  .mobile-fullscreen #tank-game-canvas {
    border-radius: 0 !important;
    flex: 1 !important;
    width: 100vw !important;
    max-width: 100vw !important;
    max-height: calc(100vh - 60px) !important;
    object-fit: contain !important;
  }

  .mobile-fullscreen .controls {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    background: rgba(0, 0, 0, 0.95) !important;
    padding: 10px !important;
    margin: 0 !important;
    z-index: 100000 !important;
    display: flex !important;
    justify-content: center !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
  }

  .mobile-fullscreen .mobile-hints {
    z-index: 100001 !important;
  }
</style>

<style is:global>
  /* Prevent scrolling when game is in mobile fullscreen */
  body.game-fullscreen {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
    height: 100% !important;
  }
</style>
